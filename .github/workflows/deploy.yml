name: Deploy Frontend to Lightsail

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout del repositorio
      - name: Checkout code
        uses: actions/checkout@v3

      # Configuración de credenciales AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Instalar lightsailctl (AWS CLI ya está preinstalado en el runner)
      - name: Install lightsailctl
        run: |
          curl -sSL "https://lightsailctl.amazonaws.com/0.14.1/linux-amd64/lightsailctl" -o lightsailctl
          sudo mv lightsailctl /usr/local/bin/lightsailctl
          sudo chmod +x /usr/local/bin/lightsailctl

      # Build y push de la imagen
      - name: Build and deploy to Lightsail
        env:
          SERVICE_NAME: ${{ secrets.AWS_SERVICE_NAME }}
          IMAGE: ${{ github.sha }}
        run: |
          echo "Building Docker image..."
          docker build \
            --build-arg VITE_AP_VERSION=${{ secrets.VITE_AP_VERSION }} \
            --build-arg VITE_API_SERVICE=${{ secrets.VITE_API_SERVICE }} \
            --build-arg VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }} \
            --build-arg VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }} \
            --build-arg VITE_FIREBASE_BUCKET=${{ secrets.VITE_FIREBASE_BUCKET }} \
            --build-arg VITE_FIREBASE_DOMAIN=${{ secrets.VITE_FIREBASE_DOMAIN }} \
            --build-arg VITE_FIREBASE_MEASURE_ID=${{ secrets.VITE_FIREBASE_MEASURE_ID }} \
            --build-arg VITE_FIREBASE_MESSAGING_ID=${{ secrets.VITE_FIREBASE_MESSAGING_ID }} \
            --build-arg VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }} \
            --build-arg VITE_FIREBASE_VAPID_KEY=${{ secrets.VITE_FIREBASE_VAPID_KEY }} \
            --build-arg VITE_IMPORT_USERS_EXCEL=${{ secrets.VITE_IMPORT_USERS_EXCEL }} \
            --build-arg VITE_PDF_MANUAL_LINK=${{ secrets.VITE_PDF_MANUAL_LINK }} \
            -t $SERVICE_NAME:$IMAGE .

          echo "Pushing Docker image to Lightsail..."
          docker push $SERVICE_NAME:$IMAGE || true  # Lightsail usa aws lightsail, no DockerHub

          echo "Deploying container service..."
          CONTAINERS=$(jq -n \
            --arg img ":$IMAGE" \
            '{
              "service": {
                "image": $img,
                "ports": { "80": "HTTP" }
              }
            }')

          PUBLIC_ENDPOINT=$(jq -n \
            '{
              "containerName": "service",
              "containerPort": 80,
              "healthCheck": { "path": "/", "intervalSeconds": 10 }
            }')

          aws lightsail create-container-service-deployment \
            --service-name "$SERVICE_NAME" \
            --containers "$CONTAINERS" \
            --public-endpoint "$PUBLIC_ENDPOINT"
