name: Debug Push to Lightsail

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    env:
      sha: ${{ github.sha }}
      region: ${{ secrets.AWS_REGION }}
      service: ${{ secrets.AWS_SERVICE_NAME }}

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Configurar AWS CLI
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. Instalar lightsailctl
      - name: Install lightsailctl
        run: |
          curl -s https://s3.us-west-2.amazonaws.com/amazonlightsailctl/latest/linux-amd64/lightsailctl -o lightsailctl
          sudo mv lightsailctl /usr/local/bin/lightsailctl
          sudo chmod +x /usr/local/bin/lightsailctl
          lightsailctl --version || echo "‚ö†Ô∏è lightsailctl no muestra versi√≥n"

      # 4. Build Docker image
      - name: Build Docker image
        run: |
          docker build \
            --build-arg VITE_AP_VERSION="${{ secrets.VITE_AP_VERSION }}" \
            --build-arg VITE_API_SERVICE="${{ secrets.VITE_API_SERVICE }}" \
            -t frontend:${{ env.sha }} .

      # 5. Verificar que la imagen existe
      - name: Debug docker images
        run: |
          echo "üîç Listando im√°genes Docker locales..."
          docker images | grep frontend || echo "‚ö†Ô∏è No se encontr√≥ la imagen frontend"

      # 6. Push a Lightsail (debug only)
      - name: Push Docker image to Lightsail
        run: |
          echo "üöÄ Subiendo imagen frontend:${{ env.sha }} a Lightsail..."

          RAW_OUTPUT=$(aws lightsail push-container-image \
            --region ${{ env.region }} \
            --service-name ${{ env.service }} \
            --label frontend \
            --image frontend:${{ env.sha }} \
            --output json)

          echo "üîç Salida cruda completa:"
          echo "$RAW_OUTPUT"

          IMAGE_NAME=$(echo "$RAW_OUTPUT" | jq -r '.containerImage.image // empty')

          if [ -z "$IMAGE_NAME" ]; then
            echo "‚ö†Ô∏è No se pudo extraer IMAGE_NAME. Revisa la salida cruda arriba."
            exit 1
          fi 

          echo "‚úÖ Imagen registrada en Lightsail como: $IMAGE_NAME"
